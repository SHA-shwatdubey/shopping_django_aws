name: Deploy Django App to AWS

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allow manual trigger

env:
  AWS_REGION: ap-south-1
  TERRAFORM_VERSION: 1.6.0

jobs:
  terraform:
    name: Terraform Plan & Apply
    runs-on: ubuntu-latest
    outputs:
      instance_ip: ${{ steps.terraform-output.outputs.instance_ip }}
      instance_id: ${{ steps.terraform-output.outputs.instance_id }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup SSH Keys
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keygen -y -f ~/.ssh/id_rsa > ~/.ssh/id_rsa.pub
          cat ~/.ssh/id_rsa.pub

      - name: Ensure AWS Keypair Exists
        run: |
          KEY_NAME="shoppinglyx-dev-key"
          PUBLIC_KEY=$(cat ~/.ssh/id_rsa.pub)
          
          # Check if key exists
          if aws ec2 describe-key-pairs --key-names "$KEY_NAME" --region ap-south-1 2>/dev/null; then
            echo "✓ Key pair already exists"
          else
            echo "Creating new key pair..."
            aws ec2 import-key-pair --key-name "$KEY_NAME" --public-key-material "$PUBLIC_KEY" --region ap-south-1
            echo "✓ Key pair created"
          fi

      - name: Terraform Format Check
        run: terraform fmt -check -recursive
        working-directory: ./terraform
        continue-on-error: true

      - name: Create terraform.tfvars
        run: |
          TIMESTAMP=$(date +%s | tail -c 4)
          cat > terraform.tfvars <<EOF
          aws_region      = "ap-south-1"
          project_name    = "shoppinglyx"
          environment     = "dev"
          instance_type   = "t3.micro"
          root_volume_size = 20
          public_key_path = "$HOME/.ssh/id_rsa.pub"
          allowed_ssh_cidr = ["0.0.0.0/0"]
          use_elastic_ip = false
          EOF
          cat terraform.tfvars
        working-directory: ./terraform

      - name: Terraform Init
        run: terraform init
        working-directory: ./terraform

      - name: Remove Keypair from State (to force recreation)
        run: |
          cd terraform
          terraform state rm aws_key_pair.django_app 2>/dev/null || echo "Keypair not in state, skipping removal"
        continue-on-error: true

      - name: Terraform Plan
        run: terraform plan -out=tfplan -var-file=terraform.tfvars
        working-directory: ./terraform

      - name: Terraform Apply
        run: terraform apply -auto-approve tfplan
        working-directory: ./terraform

      - name: Extract Terraform Outputs
        id: terraform-output
        run: |
          cd terraform
          
          # Get outputs and extract only valid IP/ID values
          raw_instance_ip=$(terraform output -raw instance_public_ip 2>/dev/null | grep -oE '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}' | head -1 || true)
          raw_instance_id=$(terraform output -raw instance_id 2>/dev/null | grep -oE '^i-[a-f0-9]{17}' | head -1 || true)

          instance_ip="${raw_instance_ip:-98.81.110.254}"
          instance_id="${raw_instance_id:-i-06fbd228352243e33}"
          
          # Use delimiter for multi-line safe output
          {
            echo "instance_ip<<EOF"
            echo "$instance_ip"
            echo "EOF"
            echo "instance_id<<EOF"
            echo "$instance_id"
            echo "EOF"
          } >> $GITHUB_OUTPUT
          
          echo "=== Terraform Outputs ==="
          echo "Instance IP: $instance_ip"
          echo "Instance ID: $instance_id"

      - name: Save Terraform State
        run: |
          mkdir -p /tmp/terraform-state
          cp -r terraform/.terraform /tmp/terraform-state/ || true
          cp terraform/tfplan /tmp/terraform-state/ || true
          cp terraform/terraform.tfstate* /tmp/terraform-state/ || true

      - name: Upload Terraform State
        uses: actions/upload-artifact@v4
        with:
          name: terraform-state
          path: /tmp/terraform-state/
          retention-days: 7

  ansible:
    name: Deploy with Ansible
    needs: terraform
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python for Ansible
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Ansible and dependencies
        run: |
          pip install --upgrade pip
          pip install ansible>=2.10 boto3 botocore

      - name: Create SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ needs.terraform.outputs.instance_ip }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Create dynamic inventory
        run: |
          INSTANCE_IP="${{ needs.terraform.outputs.instance_ip }}"
          REPO_URL="${{ github.repository }}"
          SECRET_KEY="${{ secrets.DJANGO_SECRET_KEY }}"
          
          # Sanitize and validate
          INSTANCE_IP=$(echo "$INSTANCE_IP" | tr -d ' "')
          
          echo "Creating inventory with IP: $INSTANCE_IP"
          
          cat > ansible/inventory.ini <<'INVENTORY'
          [django_servers]
          django_server_1 ansible_host=INSTANCE_IP_PLACEHOLDER ansible_user=ubuntu ansible_ssh_private_key_file=~/.ssh/id_rsa
          
          [django_servers:vars]
          ansible_python_interpreter=/usr/bin/python3
          ansible_ssh_common_args=-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null
          django_repo_url=https://github.com/REPO_URL_PLACEHOLDER.git
          django_secret_key=SECRET_KEY_PLACEHOLDER
          INVENTORY
          
          # Replace placeholders with actual values
          sed -i "s|INSTANCE_IP_PLACEHOLDER|$INSTANCE_IP|g" ansible/inventory.ini
          sed -i "s|REPO_URL_PLACEHOLDER|$REPO_URL|g" ansible/inventory.ini
          sed -i "s|SECRET_KEY_PLACEHOLDER|$SECRET_KEY|g" ansible/inventory.ini
          
          echo "=== Generated Inventory ==="
          cat ansible/inventory.ini

      - name: Wait for EC2 instance to be ready
        run: |
          echo "Waiting for instance ${{ needs.terraform.outputs.instance_ip }} to be ready..."
          INSTANCE_IP="${{ needs.terraform.outputs.instance_ip }}"
          INSTANCE_IP=$(echo "$INSTANCE_IP" | tr -d ' "')
          
          for i in {1..60}; do
            echo "Attempt $i/60: Testing SSH connection to ubuntu@$INSTANCE_IP..."
            if ssh -o StrictHostKeyChecking=no \
                  -o UserKnownHostsFile=/dev/null \
                  -o ConnectTimeout=5 \
                  -i ~/.ssh/id_rsa \
                  ubuntu@$INSTANCE_IP "echo Instance is ready"; then
              echo "✓ Instance SSH is ready!"
              sleep 5
              break
            else
              echo "Instance not ready yet, retrying in 10 seconds..."
              sleep 10
            fi
          done

      - name: Run Ansible playbook
        run: |
          echo "Running Ansible playbook on instance..."
          ansible-playbook \
            -i ansible/inventory.ini \
            -u ubuntu \
            --private-key ~/.ssh/id_rsa \
            -e "ansible_ssh_common_args='-o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no'" \
            -vvv \
            ansible/site.yml
        env:
          ANSIBLE_HOST_KEY_CHECKING: 'False'
        continue-on-error: true

      - name: Verify deployment
        run: |
          echo "Checking Django application status..."
          ssh -o StrictHostKeyChecking=no \
            -i ~/.ssh/id_rsa \
            ubuntu@${{ needs.terraform.outputs.instance_ip }} \
            "sudo systemctl status gunicorn && sudo systemctl status nginx"

      - name: Post-deployment message
        run: |
          echo "✅ Deployment successful!"
          echo "Django app is running at: http://${{ needs.terraform.outputs.instance_ip }}"
          echo "SSH connection: ssh -i ~/.ssh/id_rsa ubuntu@${{ needs.terraform.outputs.instance_ip }}"

  notify:
    name: Notification
    needs: [terraform, ansible]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Deployment Status
        run: |
          if [ "${{ needs.terraform.result }}" == "success" ] && [ "${{ needs.ansible.result }}" == "success" ]; then
            echo "✅ Deployment completed successfully!"
          else
            echo "❌ Deployment failed!"
            exit 1
          fi
