---
- name: Ensure application directory exists
  file:
    path: "{{ app_directory }}"
    state: directory
    owner: "{{ app_user }}"
    group: "{{ app_group }}"
    mode: '0755'

- name: Clone or update Django repository
  git:
    repo: "{{ repo_url }}"
    dest: "{{ app_directory }}"
    version: "{{ repo_branch }}"
    force: yes
  become_user: "{{ app_user }}"

- name: List cloned directory contents
  command: "ls -la {{ app_directory }}"
  register: dir_contents
  changed_when: false

- name: Show directory contents
  debug:
    var: dir_contents.stdout_lines

- name: Create Python virtual environment
  command: "python3.11 -m venv {{ venv_directory }}"
  args:
    creates: "{{ venv_directory }}/bin/activate"
  become_user: "{{ app_user }}"

- name: Upgrade pip in virtual environment
  pip:
    name:
      - pip
      - setuptools
      - wheel
    state: latest
    virtualenv: "{{ venv_directory }}"
    virtualenv_command: "python3.11 -m venv"

- name: Install Django and dependencies
  pip:
    name:
      - Django>=4.0
      - gunicorn
      - psycopg2-binary
      - python-decouple
    virtualenv: "{{ venv_directory }}"
    virtualenv_command: "python3.11 -m venv"
  become_user: "{{ app_user }}"

- name: Check if requirements.txt exists
  stat:
    path: "{{ app_directory }}/requirements.txt"
  register: requirements_check

- name: Install requirements.txt if it exists
  pip:
    requirements: "{{ app_directory }}/requirements.txt"
    virtualenv: "{{ venv_directory }}"
    virtualenv_command: "python3.11 -m venv"
  when: requirements_check.stat.exists
  ignore_errors: yes
  become_user: "{{ app_user }}"

- name: Create .env file for Django settings
  template:
    src: django_env.j2
    dest: "{{ app_directory }}/.env"
    owner: "{{ app_user }}"
    group: "{{ app_group }}"
    mode: '0600'

- name: Run Django migrations
  shell: |
    bash -c "source {{ venv_directory }}/bin/activate && cd {{ app_directory }} && python manage.py migrate --noinput"
  args:
    executable: /bin/bash
  become_user: "{{ app_user }}"
  environment:
    DJANGO_SETTINGS_MODULE: "shoppinglyx.settings"
    PATH: "{{ venv_directory }}/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
  ignore_errors: yes

- name: Collect static files
  shell: |
    bash -c "source {{ venv_directory }}/bin/activate && cd {{ app_directory }} && python manage.py collectstatic --noinput"
  args:
    executable: /bin/bash
  become_user: "{{ app_user }}"
  environment:
    DJANGO_SETTINGS_MODULE: "shoppinglyx.settings"
    PATH: "{{ venv_directory }}/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
  ignore_errors: yes
